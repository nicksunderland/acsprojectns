# Demographics

## Installation
```{r installation_demog}
library(acsprojectns)
library(devtools)
load_all()
library(icdb)
library(modeest)
library(kableExtra)
```

## Index ACS event
Get the index ACS event
```{r index_acs, results="markup"}
# The index event
index_acs <- msrv$sus$apc_spells |>
  # Time window
  dplyr::filter(spell_start > acs_date_min & spell_end < acs_date_max) |>
  # Emergency admission
  dplyr::filter(as.character(method_of_admission_hospital_provider_spell) %in% !!adm_method$admission_method_code) |>
  # Only cohort NHS numbers
  dplyr::filter(nhs_number %in% cohort_ids) |>
  # Collect to local
  icdb::run() |>
  # Recode the ICD10 codes
  dplyr::mutate(primary_diagnosis = icdb::icd10(primary_diagnosis_icd, 
                                                system.file("extdata", "icd10/icd10_example.yaml", package="icdb"))) %>% 
  # Make sure ICD10 codes are all valid
  {if(all(icdb::is_valid(.$primary_diagnosis))) . else stop("error1")} |>
  # Only ACS events TODO: change this to filter
  dplyr::mutate(filter_test = primary_diagnosis %in_group% c("acs_stemi", "acs_nstemi", "acs_unstable_angina")) |>
  # Only the first ACS event
  dplyr::group_by(nhs_number) |>
  dplyr::slice_min(spell_start, with_ties=F) |>
  # select the final columns 
  dplyr::select(
    nhs_number, 
    spell_start, 
    spell_end, 
    age_on_admission,
    primary_diagnosis,
    filter_test
  ) |>
  # always ungroup stuff
  dplyr::ungroup()

# Tests
stopifnot(nrow(index_acs)==length(cohort_ids),
          all(cohort_ids %in% index_acs$nhs_number))

# View
kbl(index_acs |> dplyr::slice_head(n=5), longtable = T, booktabs = T, caption = "Index ACS event")
```


## Static patient factors
Analyse the non-time varying patient factors.
```{r demographics_ethnicity, results="markup"}
# read in the ethnicity mappings
ethnicity_codes <- read.csv(system.file("ethnicity_codes/ethnicity_codes.csv", package = "acsprojectns"))

# extract the SUS ACP Spell data for the index event
dat_ethnicity <- msrv$sus$apc_spells |>
  # Just ethnicity
  dplyr::select(nhs_number, ethnic_group) |>
  # just the cohort IDs
  dplyr::filter(nhs_number %in% cohort_ids) |>
  # Add SWD attribute data
  dplyr::left_join(msrv$swd$swd_attribute |> dplyr::select(nhs_number, ethnicity), by="nhs_number") |>
  # collect to local
  icdb::run() |>
  # coalesce the sources from different tables
  dplyr::mutate(ethnic_group = dplyr::coalesce(as.character(ethnic_group),
                                               as.character(ethnicity))) |>
  # keep the modal value
  dplyr::group_by(nhs_number) |>
  dplyr::summarise(ethnic_group = acsprojectns::mode(ethnic_group))

# View 
kbl(dplyr::slice_head(dat_ethnicity, n=5), longtable = T, booktabs = T, caption = "Ethnicity data")
```

```{r demographics_sex}
#sex_codes       <- read.csv(system.file("sex_codes/sex_codes.csv", package = "acsprojectns"))
# extract the SUS ACP Spell data for the index event
# dat_ethnicity <- msrv$sus$apc_spells |>
#   # Cohort IDs
#   dplyr::filter(nhs_number %in% cohort_ids) |>
#   # Add SWD attribute data
#   dplyr::left_join(msrv$swd$swd_attribute |> dplyr::select(nhs_number, ethnicity), by="nhs_number") |>
#   # collect to local
#   icdb::run() |>
#   # combine static variables
#   dplyr::group_by(nhs_number) |>
#   # 
#   dplyr::mutate(ethnicity = )
#   
#   # Time window
#   dplyr::filter(spell_start > acs_date_min & spell_end < acs_date_max) |>
#   # Emergency admission
#   dplyr::filter(as.character(method_of_admission_hospital_provider_spell) %in% !!adm_method$admission_method_code) |>
#   # Acute coronary syndrome primary diagnosis
#   icdb::codes_from(system.file("icd10_codes", "acs.yaml", package="acsprojectns"), primary_diagnosis_icd) |>
# 
#   # remove duplicates
#   dplyr::distinct(nhs_number) |> 
#   dplyr::pull()






# <!-- index_of_multiple_deprivation_decile -->
# <!-- income_decile -->
# <!-- employment_decile -->
# <!-- urban_rural_classification -->
```





