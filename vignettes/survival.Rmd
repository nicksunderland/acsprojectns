# Survival

## Installation
```{r installation_survival}
library(acsprojectns)
library(devtools)
load_all()
library(icdb)
library(modeest)
library(kableExtra)
library(survival)
library(survminer)
library(wesanderson)
```

## Subsequent events - deaths
```{r deaths, results="markup"}
# get all of the subsequent diagnoses after the start point of the index ACS event
death_events <- msrv$mort$civil_reg |> 
  # Only cohort NHS numbers
  dplyr::filter(nhs_number %in% cohort_ids, 
                !is.na(date_of_death)) |>
  # # collect to local
  icdb::run() |>
  # shouldnt need to do this at work 
  dplyr::mutate(nhs_number = as.character(nhs_number)) |>
  # pivot longer
  dplyr::mutate(dplyr::across(-c(nhs_number, date_of_death, place_of_death_ccg_code, place_of_death), as.character)) |>
  tidyr::pivot_longer(-c(nhs_number, date_of_death, place_of_death_ccg_code, place_of_death), 
                      names_to=c("icd_code", ".value"), 
                      names_pattern="(.*)_(\\w+)", 
                      values_drop_na=TRUE) |>
  # recode the ICD10 codes
  dplyr::mutate(diagnosis = icdb::icd10(code, 
                                        system.file("icd10_codes", "icd10_ns.yaml", package="acsprojectns"))) %>% 
  # Make sure ICD10 codes are all valid
  {if(all(icdb::is_valid(.$diagnosis))) . else stop("error1 - couldn't parse all the ICD codes")} |>
  # filter out line "d", which I think corresponds to line "2" on the death certification - i.e.
  # conditions contributing but not causing the death; keep a, b, and c 
  dplyr::filter(line=="a"|line=="b"|line=="c") |>
  # extract diagnosis group or ICD string (if not listed as a group)
  dplyr::mutate(event_desc = dplyr::if_else(icdb::group_string(diagnosis)!="",
                                            icdb::group_string(diagnosis), 
                                            as.character(diagnosis))) |>
  # separate the groups if there are multiple
  tidyr::separate_longer_delim(event_desc, delim=",") |>
  # code as a death rather than the straight ICD10 code or grouping 
  dplyr::mutate(event_desc = paste0("death_", event_desc)) |>
  # clean up 
  dplyr::select(nhs_number, event_desc, event_start=date_of_death, event_end=date_of_death)
```

```{r subsequent_diagnoses, results="markup"}
# get all of the subsequent diagnoses after the start point of the index ACS event
subsequent_diagnoses <- msrv$sus$apc_spells_diagnosis |>
  # Only cohort NHS numbers
  dplyr::filter(nhs_number %in% cohort_ids) |>
  # Time window - start of the cohort window to present
  dplyr::filter(spell_start >= acs_date_min) |>
  # select the needed columns - start and end now refer to the spell the diagnosis was made; whereas
  # spell_start and spell_end still refer to the index ACS spell
  dplyr::select(nhs_number, event_start=spell_start, event_end=spell_end, 
                dplyr::matches("primary_diagnosis_icd|secondary_diagnosis_[0-9]+_icd")) |>
  # collect to local
  icdb::run() |>
  # shouldnt need to do this at work 
  dplyr::mutate(nhs_number = as.character(nhs_number)) |>
  # join the index spell data
  dplyr::right_join(index_acs |> dplyr::select(nhs_number, index_start=spell_start, index_end=spell_end), by="nhs_number") |>
  # make sure that the spell comes after (or at the same time as) the start of the index ACS spell
  dplyr::filter(event_start >= index_start) |>
  # ensure all columns characters
  dplyr::mutate(dplyr::across(dplyr::matches("primary_diagnosis_icd|secondary_diagnosis_[0-9]+_icd"),
                              ~ as.character(.x))) |>
  # pivot diagnoses to long format
  tidyr::pivot_longer(dplyr::matches("primary_diagnosis_icd|secondary_diagnosis_[0-9]+_icd"),
                      names_to="diag_pos",
                      values_to="diagnosis", 
                      values_drop_na=TRUE) |>
  # only take id, spell dates and diagnoses
  dplyr::select(nhs_number, index_start, index_end, event_start, event_end, diagnosis) |>
  # Recode the ICD10 codes
  dplyr::mutate(diagnosis = icdb::icd10(diagnosis, 
                                        system.file("icd10_codes", "icd10_ns.yaml", package="acsprojectns"))) %>% 
  # Make sure ICD10 codes are all valid
  {if(all(icdb::is_valid(.$diagnosis))) . else stop("error1 - couldn't parse all the ICD codes")} |>
  # extract diagnosis group or ICD string (if not listed as a group)
  dplyr::mutate(event_desc = dplyr::if_else(icdb::group_string(diagnosis)!="",
                                            icdb::group_string(diagnosis), 
                                            as.character(diagnosis))) |>
  # separate the groups if there are multiple
  tidyr::separate_longer_delim(event_desc, delim=",") |>
  # filter out diagnoses that cannot be subsequent events - e.g. we cannot have an ACS subsequent
  # event happening within the index ACS spell (this is the index ACS event)
  dplyr::filter(!(event_desc %in% c("acs_stemi", "acs_nstemi", "acs_unstable_angina") & 
                    #TODO: ?add cardiomyopathy diagnoses too?
                    # is an ACS and is within the index spell
                  lubridate::`%within%`(a=lubridate::interval(event_start,event_end), 
                                        b=lubridate::interval(index_start,index_end)))) |>
  # clean up 
  dplyr::select(nhs_number, event_desc, event_start, event_end)
```

```{r subsequent_procedures, results="markup"}
# get all of the subsequent diagnoses after the start point of the index ACS event
# subsequent_procedures <- msrv$sus$apc_spells_diagnosis |>
  # Only cohort NHS numbers
  
  
  
#   # read in the code mappnigs for angiograms, PCI, and coronary artery bypass
# opcs_angio_codes <- read.csv(system.file("opcs_codes/coronary_angiogram_procedure_codes.csv", package = "acsprojectns"))
# opcs_pci_codes   <- read.csv(system.file("opcs_codes/pci_procedure_codes.csv", package = "acsprojectns"))
# opcs_cabg_codes  <- read.csv(system.file("opcs_codes/cabg_procedure_codes.csv", package = "acsprojectns"))
# opcs_codes       <- rbind(opcs_angio_codes, opcs_pci_codes, opcs_cabg_codes)
# 
# index_acs_procedures <- msrv$sus$apc_spells_procedures |>
#   # Only cohort NHS numbers
#   dplyr::filter(nhs_number %in% cohort_ids) |>
#   # Time window
#   dplyr::filter(spell_start >= acs_date_min & spell_end <= acs_date_max) |>
#   # select the needed columns
#   dplyr::select(nhs_number, start=spell_start, end=spell_end, dplyr::contains("procedure")) |>
#   # collect to local
#   icdb::run() |>
#   # shouldnt need to do this at work 
#   dplyr::mutate(nhs_number = as.character(nhs_number)) |>
#   # join the index spell data
#   dplyr::right_join(index_acs |> dplyr::select(nhs_number, spell_start, spell_end), by="nhs_number") |>
#   # make sure that the spell overlaps the index spell 
#   dplyr::filter(lubridate::int_overlaps(int1 = lubridate::interval(start, end),
#                                         int2 = lubridate::interval(spell_start, spell_end))) |>
#   dplyr::select(nhs_number, dplyr::contains("procedure")) |>
#   dplyr::mutate(dplyr::across(dplyr::everything(), as.character)) |>
#   tidyr::pivot_longer(-nhs_number, names_to=c("procedure", ".value"), names_pattern="(.*)_(\\w+)") |>
#   dplyr::left_join(opcs_codes, by=c("opcs"="opcs_codes")) |>
#   dplyr::filter(!is.na(group)) |>
#   dplyr::select(-c(procedure, opcs, description)) |>
#   dplyr::group_by(nhs_number, group) |>
#   dplyr::slice_min(date, with_ties=FALSE) |>
#   tidyr::pivot_wider(names_from=group, values_from=date) |>
#   dplyr::right_join(data.frame("nhs_number"=cohort_ids), by="nhs_number")


# end goal
  # dplyr::select(nhs_number, event_desc, event_start, event_end)
```

```{r subsequent_measurements, results="markup"}
# get all of the subsequent diagnoses after the start point of the index ACS event
# subsequent_measurements <- 
  # Only cohort NHS numbers
  
  
#   
#   # Define the blood pressure medications
# diuretics <- c("chlorthalidone", "chlorothiazide", "hydrochlorothiazide", "indapamide", "metolazone", "amiloride", "spironolactone", "triamterene", "bumetanide", "furosemide", "torsemide")
# beta_blockers <- c("acebutolol", "atenolol", "betaxolol", "bisoprolol", "metoprolol", "nadolol", "pindolol", "propranolol", "solotol", "timolol")
# ace_inhibitors <- c("benazepril", "captopril", "enalapril", "fosinopril", "lisinopril", "moexipril", "perindopril", "quinapril", "ramipril", "trandolapril")
# arbs <- c("candesartan", "eprosartan", "irbesartan", "losartan", "telmisartan", "valsartan")
# ccbs <- c("amlodipine", "diltiazem", "felodipine", "isradipine", "nicardipine", "nifedipine", "nisoldipine", "verapamil")
# alpha_blockers <- c("doxazosin", "prazosin", "terazosin")
# a_b_blockers <- c("carvedilol", "labetalol")
# central_agonists <- c("methyldopa", "clonidine", "guanfacine")
# vasodilators <- c("hydralazine", "minoxidil")
# mras <- c("eplerenone","spironolactone")
# renin_inhibitors <- c("aliskiren")
# blood_pressure_meds <- c(diuretics, beta_blockers, ace_inhibitors, arbs, ccbs, alpha_blockers, a_b_blockers, central_agonists, vasodilators, mras, renin_inhibitors)
# 
# # Get the medication data
# med_filter_string <- "(?i)([A-z ]+)(\\d+\\.?\\d*)?([A-z]+)?[ ]*(?:[A-z]*)"
# medications <- svr$MODELLING_SQL_AREA$swd_measurement %>%
#   select(nhs_number, measurement_name, measurement_value) %>%
#   filter(measurement_name == "blood_pressure",
#          measurement_value != "unknown",
#          !is.na(measurement_value)) %>%
#   distinct(nhs_number) %>%
#   # joins much quicker than passing in loads of IDs
#   left_join( svr$MODELLING_SQL_AREA$swd_activity %>% select(nhs_number, prescription_date = arr_date, pod_l1, spec_l1b),
#              by = "nhs_number") %>%
#   filter(pod_l1 == "primary_care_prescription") %>%
#   filter(spec_l1b  %LIKE% '%chlorthalidone%' | spec_l1b  %LIKE% '%chlorothiazide%' | spec_l1b  %LIKE% '%hydrochlorothiazide%' | spec_l1b  %LIKE% '%indapamide%' | spec_l1b  %LIKE% '%metolazone%' | spec_l1b  %LIKE% '%amiloride%' | spec_l1b  %LIKE% '%spironolactone%' | spec_l1b  %LIKE% '%triamterene%' | spec_l1b  %LIKE% '%bumetanide%' | spec_l1b  %LIKE% '%furosemide%' | spec_l1b  %LIKE% '%torsemide%' | spec_l1b  %LIKE% '%acebutolol%' | spec_l1b  %LIKE% '%atenolol%' | spec_l1b  %LIKE% '%betaxolol%' | spec_l1b  %LIKE% '%bisoprolol%' | spec_l1b  %LIKE% '%metoprolol%' | spec_l1b  %LIKE% '%nadolol%' | spec_l1b  %LIKE% '%pindolol%' | spec_l1b  %LIKE% '%propranolol%' | spec_l1b  %LIKE% '%solotol%' | spec_l1b  %LIKE% '%timolol%' | spec_l1b  %LIKE% '%benazepril%' | spec_l1b  %LIKE% '%captopril%' | spec_l1b  %LIKE% '%enalapril%' | spec_l1b  %LIKE% '%fosinopril%' | spec_l1b  %LIKE% '%lisinopril%' | spec_l1b  %LIKE% '%moexipril%' | spec_l1b  %LIKE% '%perindopril%' | spec_l1b  %LIKE% '%quinapril%' | spec_l1b  %LIKE% '%ramipril%' | spec_l1b  %LIKE% '%trandolapril%' | spec_l1b  %LIKE% '%candesartan%' | spec_l1b  %LIKE% '%eprosartan%' | spec_l1b  %LIKE% '%irbesartan%' | spec_l1b  %LIKE% '%losartan%' | spec_l1b  %LIKE% '%telmisartan%' | spec_l1b  %LIKE% '%valsartan%' | spec_l1b  %LIKE% '%amlodipine%' | spec_l1b  %LIKE% '%diltiazem%' | spec_l1b  %LIKE% '%felodipine%' | spec_l1b  %LIKE% '%isradipine%' | spec_l1b  %LIKE% '%nicardipine%' | spec_l1b  %LIKE% '%nifedipine%' | spec_l1b  %LIKE% '%nisoldipine%' | spec_l1b  %LIKE% '%verapamil%' | spec_l1b  %LIKE% '%doxazosin%' | spec_l1b  %LIKE% '%prazosin%' | spec_l1b  %LIKE% '%terazosin%' | spec_l1b  %LIKE% '%carvedilol%' | spec_l1b  %LIKE% '%labetalol%' | spec_l1b  %LIKE% '%methyldopa%' | spec_l1b  %LIKE% '%clonidine%' | spec_l1b  %LIKE% '%guanfacine%' | spec_l1b  %LIKE% '%hydralazine%' | spec_l1b  %LIKE% '%minoxidil%' | spec_l1b  %LIKE% '%eplerenone%' | spec_l1b  %LIKE% '%spironolactone%' | spec_l1b  %LIKE% '%aliskiren%') %>%
#   select(nhs_number, prescription_date, spec_l1b) %>%
#   show_query() %>%
#   run() %>%
#   filter(nhs_number %in% !!blood_pressures$nhs_number) %>%
#   mutate(med_name  = trimws(stringr::str_match(spec_l1b, pattern = med_filter_string)[,2]),
#          med_dose  = stringr::str_match(spec_l1b, pattern = med_filter_string)[,3],
#          med_units = stringr::str_match(spec_l1b, pattern = med_filter_string)[,4]) %>%
# 
#   # check if any NAs generated here
# 
#   select(nhs_number, prescription_date, med_name) %>%
#   group_by(nhs_number, prescription_date) %>%
#   mutate(num_meds = n_distinct(med_name)) %>%
#   group_by(nhs_number) %>%
#   #arrange(prescription_date, .by_group=T) %>%
#   summarise(min_num_meds        = min(num_meds, na.rm=T),
#             #date_min_num_meds   = prescription_date[which.min(num_meds)],
#             max_num_meds        = max(num_meds, na.rm=T),
#             #date_max_num_meds   = prescription_date[which.max(num_meds)],
#             avg_num_meds        = mean(num_meds, na.rm=T)) %>%
#             # ,
#             # interval_gteq3_meds = interval(prescription_date[which.first(num_meds>=3)],
#             #                                prescription_date[which.last(num_meds>=3)], tzone="GMT")) %>%
#   ungroup()
# 
# # Combine the blood pressure data, age, and medication data
# # high_bp_and_gteq3_meds = int_overlaps(interval_hypertensive, interval_gteq3_meds),
# data <- blood_pressures %>%
#   left_join(medications, by="nhs_number") %>%
#   mutate(max_num_meds = replace_na(max_num_meds, 0),
#          age          = replace_na(age, 70),
#          bp_control_cat_any = case_when(
#          max_num_meds>=3 & age<80  & (sbp_hi>=140 | dbp_hi>=90) ~ "resistant HTN (>=3 meds, any BP)",
#          max_num_meds>=3 & age>=80 & (sbp_hi>=150 | dbp_hi>=90) ~ "resistant HTN (>=3 meds, any BP)",
#          max_num_meds<3  & age<80  & (sbp_hi>=140 | dbp_hi>=90) ~ "uncontrolled HTN (<=2 meds, any BP)",
#          max_num_meds<3  & age>=80 & (sbp_hi>=150 | dbp_hi>=90) ~ "uncontrolled HTN (<=2 meds, any BP)",
#          max_num_meds==0 ~ "normal BP (0 meds)",
#          max_num_meds<3  ~ "controlled HTN (<=2 meds, any BP)",
#          max_num_meds>=3 ~ "controlled HTN (>=3 meds, any BP)",
#          TRUE ~ "error"),
#     bp_control_cat_any = factor(bp_control_cat_any, levels = c("resistant HTN (>=3 meds, any BP)",
#                                                                "uncontrolled HTN (<=2 meds, any BP)",
#                                                                "controlled HTN (>=3 meds, any BP)",
#                                                                "controlled HTN (<=2 meds, any BP)",
#                                                                "normal BP (0 meds)")),
#     bp_control_cat_mean = case_when(
#       max_num_meds>=3 & age<80  & (sbp_av>=140 | dbp_av>=90) ~ "resistant HTN (>=3 meds, mean BP)",
#       max_num_meds>=3 & age>=80 & (sbp_av>=150 | dbp_av>=90) ~ "resistant HTN (>=3 meds, mean BP)",
#       max_num_meds<3  & age<80  & (sbp_av>=140 | dbp_av>=90) ~ "uncontrolled HTN (<=2 meds, mean BP)",
#       max_num_meds<3  & age>=80 & (sbp_av>=150 | dbp_av>=90) ~ "uncontrolled HTN (<=2 meds, mean BP)",
#       max_num_meds==0 & age<80  & (sbp_av<140  | dbp_av<90 ) ~ "normal BP (0 meds, mean BP)",
#       max_num_meds==0 & age>=80 & (sbp_av<150  | dbp_av<90 ) ~ "normal BP (0 meds, mean BP)",
#       max_num_meds<3  & age<80  & (sbp_av<140  & dbp_av<90 ) ~ "controlled HTN (<=2 meds, mean BP)",
#       max_num_meds<3  & age>=80 & (sbp_av<150  & dbp_av<90 ) ~ "controlled HTN (<=2 meds, mean BP)",
#       max_num_meds>=3 & age<80  & (sbp_av<140  & dbp_av<90 ) ~ "controlled HTN (>=3 meds, mean BP)",
#       max_num_meds>=3 & age>=80 & (sbp_av<150  & dbp_av<90 ) ~ "controlled HTN (>=3 meds, mean BP)",
#       TRUE ~ "error"),
#     bp_control_cat_mean = factor(bp_control_cat_mean, levels = c("resistant HTN (>=3 meds, mean BP)",
#                                                                  "uncontrolled HTN (<=2 meds, mean BP)",
#                                                                  "controlled HTN (>=3 meds, mean BP)",
#                                                                  "controlled HTN (<=2 meds, mean BP)",
#                                                                  "normal BP (0 meds, mean BP)")),
#     age_cat = cut(age, right=FALSE, breaks=age_bands, labels=age_band_labs)
#   )
  
  # end goal
  # dplyr::select(nhs_number, event_desc, event_start, event_end)
```

```{r subsequent_events, results="markup"}
# combined
all_subsequent_events <- dplyr::bind_rows(subsequent_diagnoses, death_events) |>
  # keep all the nhs numbers represented
  dplyr::right_join(index_acs |> dplyr::select(nhs_number, index_start=spell_start, index_end=spell_end), 
                    by=c("nhs_number")) |>
  # create the latest follow up
  dplyr::left_join(death_events |> 
                     dplyr::select(nhs_number, date_of_death=event_start) |>
                     dplyr::group_by(nhs_number) |>
                     dplyr::slice_min(date_of_death, with_ties=FALSE), by=c("nhs_number")) |>
  #TODO: add in max follow up from SWD rather than just assuming today's date
  dplyr::mutate(last_fu = dplyr::if_else(!is.na(date_of_death), date_of_death, Sys.Date())) |>
  # clean up 
  dplyr::select(nhs_number, event_desc, index_start, index_end, event_start, event_end, last_fu)

```

## Survival - all-cause death
## Table - cause of death (in first 12 months)
```{r all_cause_death, results="markup"}

outcome_groupings = list("any_death" = "^death", 
                         "acs" = "^acs")

foo <- acsprojectns::create_survival_timings(all_subsequent_events, outcome_groupings)


```

## Survival - all-cause admission back to hospital
## Table - re-admission diagnosis (in first 12 months)
```{r all_cause_readmission, results="markup"}

outcome_groupings = list("any_admission" = "^(?!death).*$")

any_readmission <- acsprojectns::create_survival_timings(all_subsequent_events |> 
                                               dplyr::filter(event_end>index_end | is.na(event_end)), outcome_groupings)

# Create the Survival object - for any readmission
surv_tt_obj_any_read <- survival::Surv(any_readmission$tstart, any_readmission$tstop, any_readmission$status)
# surv_gt_obj_any_read <- survival::Surv(rep(0, length(any_readmission$tstart)), any_readmission$tstop-any_readmission$tstart, any_readmission$status)

# Survival table
summary(survfit(surv_tt_obj_any_read ~ 1, data=any_readmission))

# Plot 
km_plot_any_readmission <- ggsurvplot(fit = surv_fit(surv_tt_obj_any_read ~ 1, data=any_readmission),
           surv.scale   = "percent",
           xscale       = 365.25,
           break.time.by= 365.25,
           conf.int      = TRUE,
           conf.int.alpha=0.25,
           palette      = wes_palette("Darjeeling1", 2),
           censor.shape ="",
           xlab = "Time from index ACS event",
           ylab = "Freedom from hospital admission",
           legend       = c(0.75,0.90),
           legend.title = "",
           legend.labs = c("Test"),
           ggtheme      = theme_classic())
```

## Survival - MACCE

## Table - MACCE diagnoses (in first 12 months)

## Cox PH model of factors affecting death and re-admission
Is frailty the main driver? If so...

## Survival by frailty score

